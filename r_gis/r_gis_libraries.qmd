
---
title: GIS Exercise - libraries
---

We are going to use data on library locations, in combination with Census
data, to understand whether there are demographic differences in
the neighborhoods served by libraries.


```{r}
library(tidyverse)
library(sf)  # The sf package provides functions for working with spatial data
library(ggspatial)

```

First, we need to read in data. We'll start by reading some Census data. The geometries for the Census data
are in the `orange_durham_wake_block_groups.shp` file in the GIS data folder, and call the dataset `census`.


```{r}
# answer:

```

Spatial data in R is represented exactly the way the tabular data we've used in the past
is. If we view the dataset, we see a table with all of the attributes, just like
we did before. There is one extra column, geometry, which contains the spatial information
about each row/feature.


```{r}
head(census)

```

There is no demographic information with the census data. That you'll have to get
from the separate CSV file, called `triangle_census.csv`. Read that as well, and call
the dataset `census_demographics`.


```{r}
# answer

```

We can just use a left join to associate this with the geographic information we already
read. Before we do that, it's a good idea to make sure the join columns are unique in
both datasets, so we don't wind up with duplicated rows.


```{r}
stopifnot(!any(duplicated(census$GEOID)))
stopifnot(!any(duplicated(census_demographics$GEOID)))

```

### Exercise: use the left_join function to associate the census with the demographics


```{r}
#| error: true
# answer:

```

We get an error here, because the shapefile GEOID field is a character, but the CSV
GEOID is a double (number)
We can re-read the census CSV and specify that the GEOID should be a character


```{r}
census_demographics = read_csv(
  file.path(DATA_PATH, "triangle_census.csv"),
  col_types=c(GEOID="character")
)

```

and re-do the join.


```{r}
# answer:

```

### Take a look at the Census data now


```{r}
head(census)

```

Now, we can plot a map, and symbolize by a variable - in this case, number of African-American individuals in each block group.


```{r}
ggplot() +
  geom_sf(data=census, aes(fill=race_black_african_american_alone)) +
    theme_minimal() +
    # and this will remove the coordinates from the axes
    theme(
      axis.text = element_blank(),
      panel.grid = element_blank()
    ) +
    annotation_scale() +
    scale_fill_binned(
      breaks=unname(quantile(census$race_black_african_american_alone), c(0, 0.2, 0.4, 0.6, 0.8, 1.0)),
      limits=range(census$race_black_african_american_alone),
      palette="Blues"
    )

```


What might be misleading about this map?

Do the block groups have the same total population?

We can calculate a percent African-American to account for population. Calculate a new column `pct_african_american` with the percent African-American in each block group.


```{r}
# answer:

```

and now map it again


```{r}
ggplot() +
  geom_sf(data=census, aes(fill=pct_african_american)) +
    theme_minimal() +
    # and this will remove the coordinates from the axes
    theme(
      axis.text = element_blank(),
      panel.grid = element_blank()
    ) +
    annotation_scale() +
    scale_fill_binned(
      # adding na.rm because some places with total_population=0 have a percent African-American
      # that is NA, because of division by zero
      # I am also rounding to whole percents
      breaks=round(unname(quantile(census$pct_african_american, c(0, 0.2, 0.4, 0.6, 0.8, 1.0), na.rm=T))),
      limits=range(census$pct_african_american),
      palette="Blues"
    )

```

## Libraries 

Now let's bring in data on libraries in Wake County, from Wake County Open Data, which are in the Libraries.csv file. Call the dataset `libraries`.


```{r}
# answer

```

Now we convert it to spatial data
We need to specify the coordinates and the coordinate reference system (projection),
which is 4326 for latitude/longitude


```{r}
# answer

```

## Lets plot this to make sure it worked


```{r}
ggplot() +
  geom_sf(data=census) +
  geom_sf(data=libraries, color="red")

```

Now let's build a 1km buffer around the libraries.


```{r}
# answer

```

### Exercise: make a map showing the census tracts, the buffer, and the libraries

```{r}
# answer

```

Now we need to identify the Census block groups which are near the libraries. Use st_intersects to add a `library_zone` column to the `census` dataset.

```{r}
# answer

```

Now, make a map showing census block groups in library service areas


```{r}
ggplot() +
  geom_sf(data=census, aes(fill=library_zone)) +
  geom_sf(data=libraries, color="red") +
  annotation_scale() +
  theme_minimal() +
  # and this will remove the coordinates from the axes
  theme(
    axis.text = element_blank(),
    panel.grid = element_blank()
  )

```


And now, we can compare the demographics of the Census tracts around libraries to the
demographics of the region as a whole, using group_by


```{r}
census |>
    st_drop_geometry() |>
    group_by(library_zone) |>
    summarize(pct_white=sum(race_white_alone) / sum(total_population) * 100)

```

Does this compare the demographics of the library service area to all of the Triangle?

To find the demographics of the whole area, we can use summarize without grouping
by any variable.


```{r}
census |>
  st_drop_geometry() |>
  summarize(pct_white=sum(race_white_alone) / sum(total_population) * 100)

```

The libraries are run by Wake County, so the demographics of Orange and Durham
counties are outside their jurisdiction. Exercise: filter the data to only include
Wake County, and repeat the above analyses.
The COUNTYFP contains Census county FIPS codes. The code for Wake County is 183.


```{r}
# answer: 

```
